name: Update Anubis Embed Version

on:
  repository_dispatch:
    types: [anubis-embed-updated]
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream Anubis version (e.g. v1.25.0)"
        required: true
        type: string
      embed_tag:
        description: "Embed tag (e.g. v1.25.0-embed)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine versions
        id: versions
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            UPSTREAM="${{ github.event.client_payload.upstream_tag }}"
            EMBED="${{ github.event.client_payload.embed_tag }}"
          else
            UPSTREAM="${{ inputs.upstream_tag }}"
            EMBED="${{ inputs.embed_tag }}"
          fi
          echo "upstream=${UPSTREAM}" >> "$GITHUB_OUTPUT"
          echo "embed=${EMBED}" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Update go.mod
        run: |
          UPSTREAM="${{ steps.versions.outputs.upstream }}"
          EMBED="${{ steps.versions.outputs.embed }}"

          sed -i "s|github.com/TecharoHQ/anubis v[^ ]*|github.com/TecharoHQ/anubis ${UPSTREAM}|" go.mod
          sed -i "s|github.com/hui1601/anubis v[^ ]*|github.com/hui1601/anubis ${EMBED}|" go.mod

          go mod tidy

      - name: Update README xcaddy example
        run: |
          EMBED="${{ steps.versions.outputs.embed }}"
          sed -i "s|github.com/hui1601/anubis@v[^ '\"]*|github.com/hui1601/anubis@${EMBED}|g" README.md

      - name: Verify build
        run: go build ./...

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: "auto/anubis-${{ steps.versions.outputs.upstream }}"
          title: "deps: update Anubis to ${{ steps.versions.outputs.upstream }}"
          body: |
            Automated update triggered by new upstream Anubis release.

            - Upstream: `${{ steps.versions.outputs.upstream }}`
            - Embed tag: `${{ steps.versions.outputs.embed }}`
            - Source: [TecharoHQ/anubis@${{ steps.versions.outputs.upstream }}](https://github.com/TecharoHQ/anubis/releases/tag/${{ steps.versions.outputs.upstream }})
          commit-message: "deps: update Anubis to ${{ steps.versions.outputs.upstream }}"
          delete-branch: true
